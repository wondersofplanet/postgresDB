import java.io.*;
import java.nio.file.*;
import java.util.*;
import java.util.stream.Collectors;

public class CsvFolderComparator {

    public static void main(String[] args) throws IOException {
        // Hardcoded folder paths (you can modify these paths as required)
        String folder1Path = "path/to/folder1";
        String folder2Path = "path/to/folder2";

        // Get the folder names dynamically from the paths
        String folder1Name = Paths.get(folder1Path).getFileName().toString();
        String folder2Name = Paths.get(folder2Path).getFileName().toString();

        File folder1 = new File(folder1Path);
        File folder2 = new File(folder2Path);

        // Get all CSV files from both folders
        List<File> folder1CsvFiles = getCsvFiles(folder1);
        List<File> folder2CsvFiles = getCsvFiles(folder2);

        // Output file for the comparison results (overwrite if it exists)
        String outputFilePath = "output.csv";
        String summaryFilePath = "summary.csv";
        
        // Initialize summary lists
        List<String> matchingCsvs = new ArrayList<>();
        List<String> differingCsvs = new ArrayList<>();
        List<String> columnMismatchCsvs = new ArrayList<>();

        try (BufferedWriter outputWriter = new BufferedWriter(new FileWriter(outputFilePath))) {
            // Track files that have already been processed
            Set<String> processedFiles = new HashSet<>();

            // Handle files in folder1
            for (File file1 : folder1CsvFiles) {
                String fileName = file1.getName();
                File file2 = new File(folder2Path + "/" + fileName);

                if (file2.exists()) {
                    // Print row and column counts
                    int[] file1Dimensions = getRowColumnCount(file1);
                    int[] file2Dimensions = getRowColumnCount(file2);

                    outputWriter.write("Comparing " + file1.getName() + ":\n");
                    outputWriter.write("No. of rows, columns in " + file1.getName() + " in " + folder1Name + ": " + file1Dimensions[0] + " rows, " + file1Dimensions[1] + " columns\n");
                    outputWriter.write("No. of rows, columns in " + file1.getName() + " in " + folder2Name + ": " + file2Dimensions[0] + " rows, " + file2Dimensions[1] + " columns\n");

                    // If column numbers don't match, skip this file
                    if (file1Dimensions[1] != file2Dimensions[1]) {
                        outputWriter.write("Column numbers don't match. Skipping comparison for this file.\n\n");
                        columnMismatchCsvs.add(fileName); // Add to column mismatch list
                        continue;
                    }

                    // Compare the two CSV files
                    boolean hasDifference = compareCsvFiles(file1, file2, folder1Name, folder2Name, outputWriter);
                    if (!hasDifference) {
                        matchingCsvs.add(fileName); // If no difference found, add to matching list
                    } else {
                        differingCsvs.add(fileName); // If difference found, add to differing list
                    }
                } else {
                    // File exists in folder1 but not in folder2
                    outputWriter.write(fileName + " is present in " + folder1Name + " but not in " + folder2Name + "\n");
                }
                processedFiles.add(fileName); // Add file to processed list
            }

            // Handle files in folder2 that haven't been processed yet
            for (File file2 : folder2CsvFiles) {
                String fileName = file2.getName();
                if (!processedFiles.contains(fileName)) {
                    // File exists in folder2 but not in folder1
                    outputWriter.write(fileName + " is present in " + folder2Name + " but not in " + folder1Name + "\n");
                }
            }
        }

        // Generate summary
        generateSummary(summaryFilePath, matchingCsvs, differingCsvs, columnMismatchCsvs);

        System.out.println("Comparison completed. Results saved in " + outputFilePath + " and summary saved in " + summaryFilePath);
    }

    // Get all CSV files in a folder
    private static List<File> getCsvFiles(File folder) {
        return Arrays.stream(Objects.requireNonNull(folder.listFiles()))
                .filter(file -> file.isFile() && file.getName().endsWith(".csv"))
                .collect(Collectors.toList());
    }

    // Get row and column counts for a CSV file
    private static int[] getRowColumnCount(File csvFile) throws IOException {
        List<String> rows = Files.readAllLines(csvFile.toPath());
        int rowCount = rows.size();
        int columnCount = rows.isEmpty() ? 0 : rows.get(0).split(",").length; // Assuming CSV is comma-separated
        return new int[]{rowCount, columnCount};
    }

    // Compare two CSV files and write differences to output
    private static boolean compareCsvFiles(File file1, File file2, String folder1Name, String folder2Name, BufferedWriter outputWriter) throws IOException {
        List<String> rowsFile1 = Files.readAllLines(file1.toPath());
        List<String> rowsFile2 = Files.readAllLines(file2.toPath());

        outputWriter.write("Comparing " + file1.getName() + ":\n");

        // Find rows present in file1 but not in file2
        outputWriter.write("Rows present in " + file1.getName() + " in " + folder1Name + " but not in " + folder2Name + ":\n");
        List<String> diff1 = new ArrayList<>(rowsFile1);
        diff1.removeAll(rowsFile2);
        boolean hasDifference = !diff1.isEmpty(); // Check if there are differences

        for (String row : diff1) {
            outputWriter.write(row + "\n");
        }

        // Find rows present in file2 but not in file1
        outputWriter.write("\nRows present in " + file1.getName() + " in " + folder2Name + " but not in " + folder1Name + ":\n");
        List<String> diff2 = new ArrayList<>(rowsFile2);
        diff2.removeAll(rowsFile1);
        hasDifference = hasDifference || !diff2.isEmpty(); // Update hasDifference if there are any differences

        for (String row : diff2) {
            outputWriter.write(row + "\n");
        }

        outputWriter.write("\n");
        return hasDifference; // Return true if differences were found
    }

    // Generate summary of comparisons
    private static void generateSummary(String summaryFilePath, List<String> matchingCsvs, List<String> differingCsvs, List<String> columnMismatchCsvs) throws IOException {
        try (BufferedWriter summaryWriter = new BufferedWriter(new FileWriter(summaryFilePath))) {
            summaryWriter.write("Summary of CSV Comparisons:\n");
            summaryWriter.write("1) Count of Matching CSVs: " + matchingCsvs.size() + "\n");
            summaryWriter.write("List of Matching CSVs:\n");
            for (String csv : matchingCsvs) {
                summaryWriter.write(csv + "\n");
            }

            summaryWriter.write("\n2) Count of CSVs with Data Differences: " + differingCsvs.size() + "\n");
            summaryWriter.write("List of CSVs with Data Differences:\n");
            for (String csv : differingCsvs) {
                summaryWriter.write(csv + "\n");
            }

            summaryWriter.write("\n3) Count of CSVs with Column Differences: " + columnMismatchCsvs.size() + "\n");
            summaryWriter.write("List of CSVs with Column Differences:\n");
            for (String csv : columnMismatchCsvs) {
                summaryWriter.write(csv + "\n");
            }
        }
    }
}
